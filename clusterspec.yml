# Tested using AWS CodeBuild
version: 0.2

phases:
  pre_build:
    commands:
      - echo Installing CDK tools...
      - yum -y install nodejs npm
      - npm install -g aws-cdk
      - pip install --upgrade aws-cdk.core
      - cd awscdk/cluster
      - pip install -r requirements.txt

  build:
    commands:
      - echo Build started on `date`
      - cdk deploy -e TTAVPC --strict --require-approval=never
      - cdk deploy -e TTARDS --strict --require-approval=never
      # get the ARN for the RDS secret from the TTARDS stack
      - rdsarn=$(aws cloudformation describe-stack-resources --stack-name TTARDS --query 'StackResources[?ResourceType==`AWS::SecretsManager::Secret`].PhysicalResourceId' --output text)
      # inject it into another secret with only the password (and no JSON structure)
      - (cd ../transferpw && python3 transferpw.py -R "${rdsarn}" -N VTT_PW)
      # - echo "and do the DB init, too: updatedb -s"
      - cdk deploy -e TTAFargate --strict --require-approval=never

  post_build:
    commands:
      - echo Further steps...
